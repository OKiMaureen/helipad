dependencies:
  build:
    - elixir
    - erlang-crypto
    - erlang-syntax-tools
    - erlang-hipe
    - erlang-parsetools
    - erlang-runtime-tools
    - erlang-observer
    - erlang-tools
    - erlang-xmerl
    - erlang-eunit
    - libsodium-dev
    - nodejs
    - npm
  runtime:
    - bash
    - curl
    - s6
    - instellar-openrc

build:
  destination: '_build/prod/rel/instellar'
  command: |
    mix local.hex --force
    mix local.rebar --force
    mix do deps.get --only prod
    npm --prefix ./assets install ./assets

    npm run deploy --prefix ./assets
    mix phx.digest

    mix release

run:
  name: instellar
  process:
    call: 'start'
  command:
    call: 'rpc'
    variations:
      migrate: Instellar.Release.Tasks.migrate
      seed: Instellar.Release.Tasks.seed

hook:
  post-install: |
    rc-update add instellar
    rc-service instellar start
    rc-service instellar migrate
  post-upgrade: |
    rc-service intellar restart
    sleep 1
    rc-service instellar migrate
  post-deinstall: |
    rc-service instellar stop
    rc-update del instellar
